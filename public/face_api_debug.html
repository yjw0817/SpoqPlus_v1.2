<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Face API Debug</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        button { padding: 10px 20px; margin: 10px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .result { background: #f8f9fa; padding: 10px; border-radius: 4px; margin-top: 10px; white-space: pre-wrap; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        video { width: 320px; height: 240px; background: #000; }
        canvas { border: 1px solid #ccc; }
    </style>
</head>
<body>
    <h1>Face API Debug Tool</h1>
    
    <!-- 1. Health Check -->
    <div class="section">
        <h3>1. Health Check Test</h3>
        <button onclick="testHealthCheck()">Health Check í…ŒìŠ¤íŠ¸</button>
        <div id="healthResult" class="result"></div>
    </div>
    
    <!-- 2. Camera Test -->
    <div class="section">
        <h3>2. Camera Test</h3>
        <button onclick="startCamera()">ì¹´ë©”ë¼ ì‹œì‘</button>
        <button onclick="captureImage()">ì´ë¯¸ì§€ ìº¡ì²˜</button>
        <button onclick="stopCamera()">ì¹´ë©”ë¼ ì¤‘ì§€</button>
        <br>
        <video id="video" autoplay></video>
        <canvas id="canvas" width="320" height="240"></canvas>
        <div id="cameraResult" class="result"></div>
    </div>
    
    <!-- 3. Face Recognition Test -->
    <div class="section">
        <h3>3. Face Recognition Test</h3>
        <button onclick="testFaceRecognition()">ì–¼êµ´ ì¸ì‹ í…ŒìŠ¤íŠ¸</button>
        <div id="faceResult" class="result"></div>
    </div>

    <script>
        let stream = null;
        let video = null;
        let canvas = null;
        let ctx = null;

        function log(elementId, message, isError = false) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = 'result ' + (isError ? 'error' : 'success');
            console.log(message);
        }

        // 1. Health Check Test
        async function testHealthCheck() {
            try {
                const response = await fetch('/api/face/health');
                const result = await response.json();
                log('healthResult', `âœ… Health Check ì„±ê³µ!\n${JSON.stringify(result, null, 2)}`);
            } catch (error) {
                log('healthResult', `âŒ Health Check ì‹¤íŒ¨: ${error.message}`, true);
            }
        }

        // 2. Camera Test
        async function startCamera() {
            try {
                video = document.getElementById('video');
                canvas = document.getElementById('canvas');
                ctx = canvas.getContext('2d');
                
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'user',
                        width: 640,
                        height: 480
                    } 
                });
                
                video.srcObject = stream;
                log('cameraResult', 'âœ… ì¹´ë©”ë¼ ì‹œì‘ ì„±ê³µ!');
            } catch (error) {
                log('cameraResult', `âŒ ì¹´ë©”ë¼ ì‹œì‘ ì‹¤íŒ¨: ${error.message}`, true);
            }
        }

        function captureImage() {
            if (!video || !stream) {
                log('cameraResult', 'âŒ ë¨¼ì € ì¹´ë©”ë¼ë¥¼ ì‹œì‘í•´ì£¼ì„¸ìš”.', true);
                return;
            }

            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageDataUrl = canvas.toDataURL('image/jpeg', 0.8);
            const base64Data = imageDataUrl.split(',')[1];
            
            log('cameraResult', `âœ… ì´ë¯¸ì§€ ìº¡ì²˜ ì„±ê³µ!\nBase64 ê¸¸ì´: ${base64Data.length} ë¬¸ì`);
            
            // ìº¡ì²˜ëœ ì´ë¯¸ì§€ë¥¼ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
            window.capturedImage = base64Data;
        }

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
                video.srcObject = null;
                log('cameraResult', 'âœ… ì¹´ë©”ë¼ ì¤‘ì§€ë¨');
            }
        }

        // 3. Face Recognition Test
        async function testFaceRecognition() {
            if (!window.capturedImage) {
                log('faceResult', 'âŒ ë¨¼ì € ì´ë¯¸ì§€ë¥¼ ìº¡ì²˜í•´ì£¼ì„¸ìš”.', true);
                return;
            }

            try {
                // FormData ì¤€ë¹„
                const formData = new FormData();
                formData.append('image_base64', window.capturedImage);
                
                // Blobìœ¼ë¡œë„ ì¶”ê°€
                const response = await fetch(`data:image/jpeg;base64,${window.capturedImage}`);
                const blob = await response.blob();
                formData.append('face_image', blob, 'test_face.jpg');

                log('faceResult', 'ğŸ”„ ì–¼êµ´ ì¸ì‹ ìš”ì²­ ì¤‘...');

                // API í˜¸ì¶œ
                const apiResponse = await fetch('/api/face/recognize', {
                    method: 'POST',
                    body: formData
                });

                console.log('API Response Status:', apiResponse.status);
                console.log('API Response Headers:', [...apiResponse.headers.entries()]);

                const result = await apiResponse.text(); // JSONì´ ì•„ë‹ ìˆ˜ë„ ìˆìœ¼ë‹ˆ textë¡œ ë¨¼ì € ë°›ê¸°
                console.log('Raw API Response:', result);

                try {
                    const jsonResult = JSON.parse(result);
                    log('faceResult', `âœ… ì–¼êµ´ ì¸ì‹ ì™„ë£Œ!\n${JSON.stringify(jsonResult, null, 2)}`);
                } catch (parseError) {
                    log('faceResult', `âŒ JSON íŒŒì‹± ì‹¤íŒ¨!\nRaw Response: ${result}`, true);
                }

            } catch (error) {
                log('faceResult', `âŒ ì–¼êµ´ ì¸ì‹ ì‹¤íŒ¨: ${error.message}`, true);
                console.error('Face Recognition Error:', error);
            }
        }

        // í˜ì´ì§€ ë¡œë“œì‹œ ìë™ìœ¼ë¡œ Health Check ì‹¤í–‰
        window.addEventListener('load', function() {
            testHealthCheck();
        });
    </script>
</body>
</html> 