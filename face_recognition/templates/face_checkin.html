<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpoqPlus ì–¼êµ´ ì¸ì‹ ì²´í¬ì¸</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #333;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 600px;
            width: 90%;
        }

        .header {
            margin-bottom: 30px;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header p {
            color: #7f8c8d;
            font-size: 1.1em;
        }

        .video-container {
            position: relative;
            margin: 30px 0;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        #videoElement {
            width: 100%;
            height: 400px;
            object-fit: cover;
            display: block;
        }

        .face-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .face-box {
            position: absolute;
            border: 3px solid #00ff00;
            border-radius: 5px;
            background: rgba(0, 255, 0, 0.1);
        }

        .face-label {
            position: absolute;
            background: rgba(0, 255, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: bold;
            transform: translateY(-100%);
        }

        .controls {
            margin: 20px 0;
        }

        .btn {
            padding: 15px 30px;
            margin: 10px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-success {
            background: linear-gradient(45deg, #00b09b, #96c93d);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 176, 155, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .status.info {
            background: rgba(52, 152, 219, 0.1);
            border: 2px solid #3498db;
            color: #2980b9;
        }

        .status.success {
            background: rgba(46, 204, 113, 0.1);
            border: 2px solid #2ecc71;
            color: #27ae60;
        }

        .status.error {
            background: rgba(231, 76, 60, 0.1);
            border: 2px solid #e74c3c;
            color: #c0392b;
        }

        .status.warning {
            background: rgba(241, 196, 15, 0.1);
            border: 2px solid #f1c40f;
            color: #d68910;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.8);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #ecf0f1;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #2c3e50;
        }

        .stat-label {
            color: #7f8c8d;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 10px;
            }

            .header h1 {
                font-size: 2em;
            }

            #videoElement {
                height: 300px;
            }

            .btn {
                padding: 12px 20px;
                font-size: 1em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ­ SpoqPlus ì–¼êµ´ ì¸ì‹</h1>
            <p>ì‹¤ì‹œê°„ ì–¼êµ´ ì¸ì‹ ì²´í¬ì¸ ì‹œìŠ¤í…œ</p>
        </div>

        <div class="video-container">
            <video id="videoElement" autoplay muted playsinline></video>
            <div class="face-overlay" id="faceOverlay"></div>
        </div>

        <div class="controls">
            <button id="startBtn" class="btn btn-primary">
                ğŸ“· ì›¹ìº  ì‹œì‘
            </button>
            <button id="checkinBtn" class="btn btn-success hidden" disabled>
                âœ… ì²´í¬ì¸ í•˜ê¸°
            </button>
        </div>

        <div id="status" class="status info">
            ğŸ“‹ ì›¹ìº ì„ ì‹œì‘í•˜ë ¤ë©´ 'ì›¹ìº  ì‹œì‘' ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”
        </div>

        <div class="stats">
            <div class="stat-card">
                <div id="faceCount" class="stat-number">0</div>
                <div class="stat-label">ê²€ì¶œëœ ì–¼êµ´</div>
            </div>
            <div class="stat-card">
                <div id="recognitionStatus" class="stat-number">-</div>
                <div class="stat-label">ì¸ì‹ ìƒíƒœ</div>
            </div>
            <div class="stat-card">
                <div id="confidenceScore" class="stat-number">0%</div>
                <div class="stat-label">ì‹ ë¢°ë„</div>
            </div>
        </div>
    </div>

    <script>
        class FaceRecognitionApp {
            constructor() {
                this.video = document.getElementById('videoElement');
                this.startBtn = document.getElementById('startBtn');
                this.checkinBtn = document.getElementById('checkinBtn');
                this.status = document.getElementById('status');
                this.faceOverlay = document.getElementById('faceOverlay');
                
                this.isStreaming = false;
                this.isProcessing = false;
                this.detectionInterval = null;
                this.lastRecognition = null;
                
                this.init();
            }

            init() {
                this.startBtn.addEventListener('click', () => this.startWebcam());
                this.checkinBtn.addEventListener('click', () => this.performCheckin());
                
                // ì„œë²„ ìƒíƒœ í™•ì¸
                this.checkServerStatus();
            }

            async checkServerStatus() {
                try {
                    const response = await fetch('/api/face/health');
                    if (response.ok) {
                        const data = await response.json();
                        this.updateStatus('success', `ğŸŸ¢ ì„œë²„ ì—°ê²°ë¨ (OpenCV ${data.opencv_version})`);
                    } else {
                        this.updateStatus('error', 'âŒ ì„œë²„ ì—°ê²° ì‹¤íŒ¨');
                    }
                } catch (error) {
                    this.updateStatus('error', 'âŒ ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                }
            }

            async startWebcam() {
                try {
                    this.updateStatus('info', 'ğŸ“· ì›¹ìº  ì ‘ê·¼ ê¶Œí•œì„ ìš”ì²­ì¤‘...');
                    
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            width: { ideal: 640 },
                            height: { ideal: 480 },
                            facingMode: 'user'
                        },
                        audio: false
                    });

                    this.video.srcObject = stream;
                    this.isStreaming = true;
                    
                    this.video.onloadedmetadata = () => {
                        this.updateStatus('success', 'âœ… ì›¹ìº ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤. ì–¼êµ´ì„ ì¹´ë©”ë¼ì— ë§ì¶°ì£¼ì„¸ìš”');
                        this.startBtn.textContent = 'ğŸ›‘ ì›¹ìº  ì •ì§€';
                        this.startBtn.onclick = () => this.stopWebcam();
                        this.checkinBtn.classList.remove('hidden');
                        
                        // ì–¼êµ´ ê²€ì¶œ ì‹œì‘
                        this.startFaceDetection();
                    };

                } catch (error) {
                    console.error('ì›¹ìº  ì ‘ê·¼ ì˜¤ë¥˜:', error);
                    this.updateStatus('error', 'âŒ ì›¹ìº ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”');
                }
            }

            stopWebcam() {
                if (this.video.srcObject) {
                    this.video.srcObject.getTracks().forEach(track => track.stop());
                    this.video.srcObject = null;
                }
                
                if (this.detectionInterval) {
                    clearInterval(this.detectionInterval);
                    this.detectionInterval = null;
                }
                
                this.isStreaming = false;
                this.startBtn.textContent = 'ğŸ“· ì›¹ìº  ì‹œì‘';
                this.startBtn.onclick = () => this.startWebcam();
                this.checkinBtn.classList.add('hidden');
                this.faceOverlay.innerHTML = '';
                
                this.updateStatus('info', 'ğŸ“‹ ì›¹ìº ì´ ì •ì§€ë˜ì—ˆìŠµë‹ˆë‹¤');
                this.updateStats(0, '-', '0%');
            }

            startFaceDetection() {
                this.detectionInterval = setInterval(() => {
                    if (!this.isProcessing && this.isStreaming) {
                        this.detectFaces();
                    }
                }, 1000); // 1ì´ˆë§ˆë‹¤ ê²€ì¶œ
            }

            async detectFaces() {
                try {
                    this.isProcessing = true;
                    
                    // ìº”ë²„ìŠ¤ì— í˜„ì¬ í”„ë ˆì„ ìº¡ì²˜
                    const canvas = document.createElement('canvas');
                    canvas.width = this.video.videoWidth;
                    canvas.height = this.video.videoHeight;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(this.video, 0, 0);
                    
                    // ì´ë¯¸ì§€ë¥¼ Blobìœ¼ë¡œ ë³€í™˜
                    const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.8));
                    
                    // ì„œë²„ë¡œ ì „ì†¡
                    const formData = new FormData();
                    formData.append('image', blob, 'frame.jpg');
                    
                    const response = await fetch('/api/face/detect', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        this.handleDetectionResult(data);
                        
                        // ì–¼êµ´ì´ ê²€ì¶œë˜ë©´ ì¸ì‹ ì‹œë„
                        if (data.face_count > 0) {
                            this.attemptRecognition(formData);
                        }
                    } else {
                        console.error('ê²€ì¶œ API ì˜¤ë¥˜:', response.status);
                    }
                    
                } catch (error) {
                    console.error('ì–¼êµ´ ê²€ì¶œ ì˜¤ë¥˜:', error);
                } finally {
                    this.isProcessing = false;
                }
            }

            async attemptRecognition(formData) {
                try {
                    const response = await fetch('/api/face/recognize_simulate', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        this.handleRecognitionResult(data);
                    }
                } catch (error) {
                    console.error('ì¸ì‹ ì˜¤ë¥˜:', error);
                }
            }

            handleDetectionResult(data) {
                this.faceOverlay.innerHTML = '';
                
                if (data.success && data.faces) {
                    // ë¹„ë””ì˜¤ì™€ ì‹¤ì œ ì´ë¯¸ì§€ í¬ê¸° ë¹„ìœ¨ ê³„ì‚°
                    const videoRect = this.video.getBoundingClientRect();
                    const scaleX = videoRect.width / data.image_size.width;
                    const scaleY = videoRect.height / data.image_size.height;
                    
                    data.faces.forEach((face, index) => {
                        const faceBox = document.createElement('div');
                        faceBox.className = 'face-box';
                        faceBox.style.left = (face.x * scaleX) + 'px';
                        faceBox.style.top = (face.y * scaleY) + 'px';
                        faceBox.style.width = (face.width * scaleX) + 'px';
                        faceBox.style.height = (face.height * scaleY) + 'px';
                        
                        const label = document.createElement('div');
                        label.className = 'face-label';
                        label.textContent = `ì–¼êµ´ ${index + 1}`;
                        label.style.left = (face.x * scaleX) + 'px';
                        label.style.top = (face.y * scaleY) + 'px';
                        
                        this.faceOverlay.appendChild(faceBox);
                        this.faceOverlay.appendChild(label);
                    });
                }
                
                this.updateStats(data.face_count, '-', '0%');
                
                if (data.face_count > 0) {
                    this.updateStatus('info', `ğŸ‘ï¸ ${data.face_count}ê°œì˜ ì–¼êµ´ì´ ê²€ì¶œë˜ì—ˆìŠµë‹ˆë‹¤`);
                    this.checkinBtn.disabled = false;
                } else {
                    this.updateStatus('warning', 'ğŸ‘€ ì–¼êµ´ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì¹´ë©”ë¼ ì •ë©´ì„ ë´ì£¼ì„¸ìš”');
                    this.checkinBtn.disabled = true;
                }
            }

            handleRecognitionResult(data) {
                if (data.success) {
                    this.lastRecognition = data;
                    this.updateStats(
                        document.getElementById('faceCount').textContent,
                        data.member_name,
                        Math.round(data.confidence * 100) + '%'
                    );
                    this.updateStatus('success', 
                        `âœ… ${data.member_name}ë‹˜ì´ ì¸ì‹ë˜ì—ˆìŠµë‹ˆë‹¤ (ì‹ ë¢°ë„: ${Math.round(data.confidence * 100)}%)`
                    );
                } else {
                    this.updateStats(
                        document.getElementById('faceCount').textContent,
                        'ë¯¸ì¸ì‹',
                        '0%'
                    );
                }
            }

            async performCheckin() {
                if (!this.lastRecognition) {
                    this.updateStatus('warning', 'âš ï¸ ë¨¼ì € ì–¼êµ´ ì¸ì‹ì´ í•„ìš”í•©ë‹ˆë‹¤');
                    return;
                }
                
                this.checkinBtn.innerHTML = '<div class="loading"></div>ì²´í¬ì¸ ì¤‘...';
                this.checkinBtn.disabled = true;
                
                try {
                    // ì‹¤ì œ ì²´í¬ì¸ ë¡œì§ (DB ì €ì¥ ë“±)
                    await new Promise(resolve => setTimeout(resolve, 1500)); // ì‹œë®¬ë ˆì´ì…˜
                    
                    this.updateStatus('success', 
                        `ğŸ‰ ${this.lastRecognition.member_name}ë‹˜ ì²´í¬ì¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!`
                    );
                    
                    // 3ì´ˆ í›„ ë¦¬ì…‹
                    setTimeout(() => {
                        this.checkinBtn.innerHTML = 'âœ… ì²´í¬ì¸ í•˜ê¸°';
                        this.checkinBtn.disabled = false;
                        this.lastRecognition = null;
                    }, 3000);
                    
                } catch (error) {
                    this.updateStatus('error', 'âŒ ì²´í¬ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
                    this.checkinBtn.innerHTML = 'âœ… ì²´í¬ì¸ í•˜ê¸°';
                    this.checkinBtn.disabled = false;
                }
            }

            updateStatus(type, message) {
                this.status.className = `status ${type}`;
                this.status.textContent = message;
            }

            updateStats(faceCount, recognition, confidence) {
                document.getElementById('faceCount').textContent = faceCount;
                document.getElementById('recognitionStatus').textContent = recognition;
                document.getElementById('confidenceScore').textContent = confidence;
            }
        }

        // ì•± ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            new FaceRecognitionApp();
        });
    </script>
</body>
</html> 