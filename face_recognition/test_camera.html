<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Face Recognition Camera Test</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #f5f5f5; 
        }
        .container { 
            max-width: 800px; 
            margin: 0 auto; 
            background: white; 
            padding: 20px; 
            border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header { 
            text-align: center; 
            color: #333; 
            margin-bottom: 30px; 
        }
        .camera-container {
            text-align: center;
            margin: 20px 0;
        }
        video {
            border: 2px solid #ddd;
            border-radius: 10px;
            max-width: 100%;
        }
        canvas {
            display: none;
        }
        .button-group { 
            display: flex; 
            gap: 10px; 
            justify-content: center; 
            margin: 20px 0;
            flex-wrap: wrap;
        }
        button { 
            padding: 12px 24px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            font-weight: bold; 
            font-size: 14px;
            transition: all 0.3s;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-info { background: #17a2b8; color: white; }
        .result { 
            margin: 20px 0; 
            padding: 15px; 
            border-radius: 8px; 
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { 
            background: #d4edda; 
            border: 1px solid #c3e6cb; 
            color: #155724; 
        }
        .error { 
            background: #f8d7da; 
            border: 1px solid #f5c6cb; 
            color: #721c24; 
        }
        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .status-online { background: #28a745; }
        .status-offline { background: #dc3545; }
        .preview-image {
            max-width: 200px;
            margin: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“· Face Recognition Camera Test</h1>
            <p>ì›¹ìº ì„ ì‚¬ìš©í•œ ì–¼êµ´ ì¸ì‹ í…ŒìŠ¤íŠ¸</p>
            <div id="serverStatus">
                <span class="status-indicator status-offline"></span>
                ì„œë²„ ìƒíƒœ í™•ì¸ ì¤‘...
            </div>
        </div>
        
        <div class="camera-container">
            <video id="videoElement" width="640" height="480" autoplay></video>
            <canvas id="canvasElement" width="640" height="480"></canvas>
            <img id="capturedImage" class="preview-image" style="display:none;">
        </div>
        
        <div class="button-group">
            <button class="btn-success" onclick="startCamera()">ğŸ“· ì¹´ë©”ë¼ ì‹œì‘</button>
            <button class="btn-danger" onclick="stopCamera()">â¹ï¸ ì¹´ë©”ë¼ ì •ì§€</button>
        </div>
        
        <div class="button-group">
            <button class="btn-primary" onclick="captureAndRecognize()">ğŸ” ì–¼êµ´ ì¸ì‹</button>
            <button class="btn-info" onclick="captureAndDetect()">ğŸ” ì–¼êµ´ ê²€ì¶œ</button>
            <button class="btn-warning" onclick="captureAndRegister()">ğŸ“ ì–¼êµ´ ë“±ë¡</button>
        </div>
        
        <div id="memberInput" style="display:none; text-align:center; margin: 20px;">
            <input type="text" id="memberNo" placeholder="íšŒì›ë²ˆí˜¸ ì…ë ¥" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            <button class="btn-success" onclick="confirmRegister()">ë“±ë¡ í™•ì¸</button>
            <button class="btn-danger" onclick="cancelRegister()">ì·¨ì†Œ</button>
        </div>
        
        <div id="result"></div>
    </div>
    
    <script>
        let cameraStream = null;
        let capturedImageData = null;
        const SERVER_URL = 'http://localhost:5002';
        
        // ì„œë²„ ìƒíƒœ í™•ì¸
        async function checkServerStatus() {
            const statusElement = document.getElementById('serverStatus');
            try {
                const response = await fetch(`${SERVER_URL}/api/face/health`, {
                    method: 'GET',
                    mode: 'cors'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    statusElement.innerHTML = `
                        <span class="status-indicator status-online"></span>
                        ì„œë²„ ì˜¨ë¼ì¸ - ${data.service} v${data.version}
                    `;
                } else {
                    throw new Error('Server not responding');
                }
            } catch (error) {
                statusElement.innerHTML = `
                    <span class="status-indicator status-offline"></span>
                    ì„œë²„ ì˜¤í”„ë¼ì¸ - ${SERVER_URL}ì—ì„œ ì„œë²„ë¥¼ ì‹œì‘í•´ì£¼ì„¸ìš”
                `;
            }
        }
        
        // ì¹´ë©”ë¼ ì‹œì‘
        async function startCamera() {
            const videoElement = document.getElementById('videoElement');
            
            try {
                // ê¸°ì¡´ ìŠ¤íŠ¸ë¦¼ì´ ìˆìœ¼ë©´ ì¢…ë£Œ
                if (cameraStream) {
                    stopCamera();
                }
                
                // ì¹´ë©”ë¼ ê¶Œí•œ ìš”ì²­ ë° ìŠ¤íŠ¸ë¦¼ ê°€ì ¸ì˜¤ê¸°
                cameraStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: 'user' // ì „ë©´ ì¹´ë©”ë¼ ìš°ì„ 
                    } 
                });
                
                videoElement.srcObject = cameraStream;
                showResult('ì¹´ë©”ë¼ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
                
            } catch (error) {
                showResult(`ì¹´ë©”ë¼ ì ‘ê·¼ ì˜¤ë¥˜: ${error.message}`, 'error');
                console.error('ì¹´ë©”ë¼ ì˜¤ë¥˜:', error);
            }
        }
        
        // ì¹´ë©”ë¼ ì •ì§€
        function stopCamera() {
            const videoElement = document.getElementById('videoElement');
            
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
                videoElement.srcObject = null;
                showResult('ì¹´ë©”ë¼ê°€ ì •ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
            }
        }
        
        // ì´ë¯¸ì§€ ìº¡ì²˜
        function captureImage() {
            const videoElement = document.getElementById('videoElement');
            const canvasElement = document.getElementById('canvasElement');
            const context = canvasElement.getContext('2d');
            
            // ë¹„ë””ì˜¤ í”„ë ˆì„ì„ ìº”ë²„ìŠ¤ì— ê·¸ë¦¬ê¸°
            context.drawImage(videoElement, 0, 0, canvasElement.width, canvasElement.height);
            
            // ìº”ë²„ìŠ¤ë¥¼ Base64ë¡œ ë³€í™˜
            const imageDataUrl = canvasElement.toDataURL('image/jpeg', 0.9);
            
            // ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
            const previewImage = document.getElementById('capturedImage');
            previewImage.src = imageDataUrl;
            previewImage.style.display = 'inline-block';
            
            return imageDataUrl;
        }
        
        // ì–¼êµ´ ì¸ì‹
        async function captureAndRecognize() {
            if (!cameraStream) {
                showResult('ë¨¼ì € ì¹´ë©”ë¼ë¥¼ ì‹œì‘í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            const imageData = captureImage();
            showResult('ì–¼êµ´ ì¸ì‹ ì¤‘...', 'info');
            
            try {
                const response = await fetch(`${SERVER_URL}/api/face/recognize`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        image: imageData,
                        param1: 'TEST',
                        param2: 'CAM'
                    })
                });
                
                const data = await response.json();
                displayDetailedResult(data, 'ì–¼êµ´ ì¸ì‹');
                
            } catch (error) {
                showResult(`ì¸ì‹ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }
        
        // ì–¼êµ´ ê²€ì¶œ
        async function captureAndDetect() {
            if (!cameraStream) {
                showResult('ë¨¼ì € ì¹´ë©”ë¼ë¥¼ ì‹œì‘í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            const imageData = captureImage();
            showResult('ì–¼êµ´ ê²€ì¶œ ì¤‘...', 'info');
            
            try {
                const response = await fetch(`${SERVER_URL}/api/face/detect_for_registration`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        image: imageData,
                        param1: 'TEST',
                        param2: 'CAM'
                    })
                });
                
                const data = await response.json();
                displayDetailedResult(data, 'ì–¼êµ´ ê²€ì¶œ');
                
            } catch (error) {
                showResult(`ê²€ì¶œ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }
        
        // ì–¼êµ´ ë“±ë¡
        function captureAndRegister() {
            if (!cameraStream) {
                showResult('ë¨¼ì € ì¹´ë©”ë¼ë¥¼ ì‹œì‘í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            capturedImageData = captureImage();
            document.getElementById('memberInput').style.display = 'block';
            document.getElementById('memberNo').focus();
        }
        
        // ë“±ë¡ í™•ì¸
        async function confirmRegister() {
            const memberNo = document.getElementById('memberNo').value;
            
            if (!memberNo) {
                alert('íšŒì›ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            showResult('ì–¼êµ´ ë“±ë¡ ì¤‘...', 'info');
            document.getElementById('memberInput').style.display = 'none';
            
            try {
                const response = await fetch(`${SERVER_URL}/api/face/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        mem_sno: memberNo,
                        image: capturedImageData,
                        param1: 'TEST',
                        param2: 'CAM'
                    })
                });
                
                const data = await response.json();
                displayDetailedResult(data, 'ì–¼êµ´ ë“±ë¡');
                
                if (data.success && data.face_saved) {
                    document.getElementById('memberNo').value = '';
                }
                
            } catch (error) {
                showResult(`ë“±ë¡ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }
        
        // ë“±ë¡ ì·¨ì†Œ
        function cancelRegister() {
            document.getElementById('memberInput').style.display = 'none';
            document.getElementById('memberNo').value = '';
            capturedImageData = null;
        }
        
        // ê²°ê³¼ í‘œì‹œ
        function showResult(message, type = 'info') {
            const resultDiv = document.getElementById('result');
            resultDiv.className = `result ${type}`;
            resultDiv.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong> - ${message}`;
        }
        
        // ìƒì„¸ ê²°ê³¼ í‘œì‹œ
        function displayDetailedResult(data, operation) {
            const resultDiv = document.getElementById('result');
            const isSuccess = data.success || data.face_detected || data.matched;
            
            let html = `<div class="result ${isSuccess ? 'success' : 'error'}">`;
            html += `<h3>ğŸ“Š ${operation} ê²°ê³¼</h3>`;
            html += `<div style="margin: 10px 0;">`;
            
            // ì£¼ìš” ì •ë³´ í‘œì‹œ
            if (data.matched) {
                html += `<div>âœ… <strong>ì¸ì‹ ì„±ê³µ!</strong> íšŒì›ë²ˆí˜¸: ${data.member_id}</div>`;
                html += `<div>ğŸ“Š ì‹ ë¢°ë„: ${(data.similarity * 100).toFixed(1)}%</div>`;
            } else if (data.face_saved) {
                html += `<div>âœ… <strong>ë“±ë¡ ì„±ê³µ!</strong> íšŒì›ë²ˆí˜¸: ${data.member_id}</div>`;
            } else if (data.face_detected !== undefined) {
                html += `<div>ì–¼êµ´ ê²€ì¶œ: ${data.face_detected ? 'âœ… ì„±ê³µ' : 'âŒ ì‹¤íŒ¨'}</div>`;
                html += `<div>ë“±ë¡ ì í•©ì„±: ${data.suitable_for_registration ? 'âœ… ì í•©' : 'âŒ ë¶€ì í•©'}</div>`;
            }
            
            // í’ˆì§ˆ ì •ë³´
            if (data.quality_score !== undefined) {
                const qualityPercent = (data.quality_score * 100).toFixed(1);
                const qualityColor = data.quality_score >= 0.7 ? 'green' : data.quality_score >= 0.5 ? 'orange' : 'red';
                html += `<div>í’ˆì§ˆ ì ìˆ˜: <span style="color:${qualityColor}; font-weight:bold;">${qualityPercent}%</span></div>`;
            }
            
            // ê¶Œì¥ì‚¬í•­
            if (data.recommendations && data.recommendations.length > 0) {
                html += `<div style="margin-top: 10px;"><strong>ğŸ’¡ ê¶Œì¥ì‚¬í•­:</strong>`;
                html += '<ul style="margin: 5px 0;">';
                data.recommendations.forEach(rec => {
                    html += `<li>${rec}</li>`;
                });
                html += '</ul></div>';
            }
            
            // ì²˜ë¦¬ ì‹œê°„
            if (data.processing_time_ms !== undefined) {
                html += `<div style="margin-top: 10px; color: #666;">â±ï¸ ì²˜ë¦¬ ì‹œê°„: ${data.processing_time_ms}ms</div>`;
            }
            
            html += `</div>`;
            
            // ì „ì²´ JSON í‘œì‹œ
            html += `<details style="margin-top: 10px;">`;
            html += `<summary style="cursor: pointer;">ì „ì²´ ì‘ë‹µ ë°ì´í„° ë³´ê¸°</summary>`;
            html += `<pre style="margin-top: 5px; font-size: 12px;">${JSON.stringify(data, null, 2)}</pre>`;
            html += `</details>`;
            
            html += `</div>`;
            
            resultDiv.innerHTML = html;
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì„œë²„ ìƒíƒœ í™•ì¸
        window.onload = function() {
            checkServerStatus();
            // 5ì´ˆë§ˆë‹¤ ì„œë²„ ìƒíƒœ í™•ì¸
            setInterval(checkServerStatus, 5000);
        };
        
        // í˜ì´ì§€ ë– ë‚  ë•Œ ì¹´ë©”ë¼ ì •ì§€
        window.onbeforeunload = function() {
            stopCamera();
        };
    </script>
</body>
</html>