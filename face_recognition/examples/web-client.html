<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Face Recognition Web Client</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1, h2 {
            color: #333;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="text"], input[type="file"], select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }
        .error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .preview {
            max-width: 300px;
            margin: 10px 0;
        }
        .preview img {
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #dee2e6;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            font-size: 16px;
        }
        .tab.active {
            border-bottom-color: #007bff;
            color: #007bff;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .camera-container {
            position: relative;
            display: inline-block;
        }
        #video {
            width: 100%;
            max-width: 640px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        #canvas {
            display: none;
        }
    </style>
</head>
<body>
    <h1>ğŸ” Face Recognition Web Client</h1>
    
    <div class="container">
        <h2>ì„œë²„ ì„¤ì •</h2>
        <div class="form-group">
            <label for="serverUrl">API Server URL:</label>
            <input type="text" id="serverUrl" value="http://localhost:5002" />
        </div>
        <button onclick="checkHealth()">ì„œë²„ ìƒíƒœ í™•ì¸</button>
        <div id="healthResult"></div>
    </div>

    <div class="container">
        <div class="tabs">
            <button class="tab active" onclick="showTab('register')">ì–¼êµ´ ë“±ë¡</button>
            <button class="tab" onclick="showTab('recognize')">ì–¼êµ´ ì¸ì‹</button>
            <button class="tab" onclick="showTab('checkin')">ì²´í¬ì¸</button>
            <button class="tab" onclick="showTab('camera')">ì¹´ë©”ë¼ ìº¡ì²˜</button>
        </div>

        <!-- ì–¼êµ´ ë“±ë¡ íƒ­ -->
        <div id="register" class="tab-content active">
            <h3>ì–¼êµ´ ë“±ë¡</h3>
            <div class="form-group">
                <label for="memberId">íšŒì› ID:</label>
                <input type="text" id="memberId" placeholder="MEM001" />
            </div>
            <div class="form-group">
                <label for="registerImage">ì´ë¯¸ì§€ ì„ íƒ:</label>
                <input type="file" id="registerImage" accept="image/*" onchange="previewImage(this, 'registerPreview')" />
            </div>
            <div class="form-group">
                <label for="securityLevel">ë³´ì•ˆ ë ˆë²¨:</label>
                <select id="securityLevel">
                    <option value="1">ë ˆë²¨ 1 (ë‚®ìŒ)</option>
                    <option value="2">ë ˆë²¨ 2 (ì¤‘ê°„)</option>
                    <option value="3" selected>ë ˆë²¨ 3 (ë†’ìŒ)</option>
                </select>
            </div>
            <div class="form-group">
                <label for="notes">ë©”ëª¨:</label>
                <input type="text" id="notes" placeholder="ë“±ë¡ ë©”ëª¨ (ì„ íƒì‚¬í•­)" />
            </div>
            <div id="registerPreview" class="preview"></div>
            <button onclick="checkQuality()">í’ˆì§ˆ ê²€ì‚¬</button>
            <button onclick="registerFace()">ì–¼êµ´ ë“±ë¡</button>
            <div id="registerResult" class="result" style="display:none;"></div>
        </div>

        <!-- ì–¼êµ´ ì¸ì‹ íƒ­ -->
        <div id="recognize" class="tab-content">
            <h3>ì–¼êµ´ ì¸ì‹</h3>
            <div class="form-group">
                <label for="recognizeImage">ì´ë¯¸ì§€ ì„ íƒ:</label>
                <input type="file" id="recognizeImage" accept="image/*" onchange="previewImage(this, 'recognizePreview')" />
            </div>
            <div class="form-group">
                <label for="compCd">íšŒì‚¬ ì½”ë“œ (ì„ íƒ):</label>
                <input type="text" id="compCd" placeholder="C001" />
            </div>
            <div class="form-group">
                <label for="bcoffCd">ì§€ì  ì½”ë“œ (ì„ íƒ):</label>
                <input type="text" id="bcoffCd" placeholder="B001" />
            </div>
            <div id="recognizePreview" class="preview"></div>
            <button onclick="recognizeFace()">ì–¼êµ´ ì¸ì‹</button>
            <div id="recognizeResult" class="result" style="display:none;"></div>
        </div>

        <!-- ì²´í¬ì¸ íƒ­ -->
        <div id="checkin" class="tab-content">
            <h3>ì²´í¬ì¸ìš© ì–¼êµ´ ì¸ì‹</h3>
            <div class="form-group">
                <label for="checkinImage">ì´ë¯¸ì§€ ì„ íƒ:</label>
                <input type="file" id="checkinImage" accept="image/*" onchange="previewImage(this, 'checkinPreview')" />
            </div>
            <div class="form-group">
                <label for="checkinCompCd">íšŒì‚¬ ì½”ë“œ:</label>
                <input type="text" id="checkinCompCd" placeholder="C001" value="C001" />
            </div>
            <div class="form-group">
                <label for="checkinBcoffCd">ì§€ì  ì½”ë“œ:</label>
                <input type="text" id="checkinBcoffCd" placeholder="B001" value="B001" />
            </div>
            <div id="checkinPreview" class="preview"></div>
            <button onclick="checkinFace()">ì²´í¬ì¸</button>
            <div id="checkinResult" class="result" style="display:none;"></div>
        </div>

        <!-- ì¹´ë©”ë¼ ìº¡ì²˜ íƒ­ -->
        <div id="camera" class="tab-content">
            <h3>ì¹´ë©”ë¼ ìº¡ì²˜</h3>
            <div class="camera-container">
                <video id="video" autoplay></video>
                <canvas id="canvas"></canvas>
            </div>
            <div class="form-group">
                <button onclick="startCamera()">ì¹´ë©”ë¼ ì‹œì‘</button>
                <button onclick="capturePhoto()">ì‚¬ì§„ ì´¬ì˜</button>
                <button onclick="stopCamera()">ì¹´ë©”ë¼ ì •ì§€</button>
            </div>
            <div id="capturedPreview" class="preview"></div>
            <div class="form-group">
                <label>ì´¬ì˜í•œ ì‚¬ì§„ìœ¼ë¡œ:</label>
                <button onclick="useForRegister()">ë“±ë¡í•˜ê¸°</button>
                <button onclick="useForRecognize()">ì¸ì‹í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let currentStream = null;
        let capturedImageData = null;

        // API í´ë¼ì´ì–¸íŠ¸ í´ë˜ìŠ¤
        class FaceRecognitionClient {
            constructor(baseUrl) {
                this.baseUrl = baseUrl;
            }

            async makeRequest(method, endpoint, data = null) {
                const url = `${this.baseUrl}${endpoint}`;
                const options = {
                    method: method,
                    headers: {
                        'Accept': 'application/json'
                    }
                };

                if (method !== 'GET' && data) {
                    options.headers['Content-Type'] = 'application/json';
                    options.body = JSON.stringify(data);
                }

                try {
                    const response = await fetch(url, options);
                    const result = await response.json();
                    return result;
                } catch (error) {
                    return {
                        success: false,
                        error: 'Network error',
                        message: error.message
                    };
                }
            }

            async healthCheck() {
                return this.makeRequest('GET', '/api/face/health');
            }

            async registerFace(memberId, imageData, securityLevel = 3, notes = null) {
                const data = {
                    member_id: memberId,
                    image: imageData,
                    security_level: securityLevel
                };
                if (notes) data.notes = notes;
                return this.makeRequest('POST', '/api/face/register', data);
            }

            async recognizeFace(imageData, compCd = null, bcoffCd = null) {
                const data = { image: imageData };
                if (compCd) data.comp_cd = compCd;
                if (bcoffCd) data.bcoff_cd = bcoffCd;
                return this.makeRequest('POST', '/api/face/recognize', data);
            }

            async recognizeForCheckin(imageData, compCd, bcoffCd, securityLevel = 3) {
                const data = {
                    image: imageData,
                    comp_cd: compCd,
                    bcoff_cd: bcoffCd,
                    security_level: securityLevel
                };
                return this.makeRequest('POST', '/api/face/recognize_for_checkin', data);
            }

            async detectForRegistration(imageData) {
                return this.makeRequest('POST', '/api/face/detect_for_registration', { image: imageData });
            }
        }

        // í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
        function getClient() {
            const serverUrl = document.getElementById('serverUrl').value;
            return new FaceRecognitionClient(serverUrl);
        }

        // íƒ­ ì „í™˜
        function showTab(tabName) {
            // ëª¨ë“  íƒ­ê³¼ ì»¨í…ì¸  ìˆ¨ê¸°ê¸°
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // ì„ íƒí•œ íƒ­ í‘œì‹œ
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°
        function previewImage(input, previewId) {
            const preview = document.getElementById(previewId);
            
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    preview.innerHTML = `<img src="${e.target.result}" alt="Preview">`;
                };
                
                reader.readAsDataURL(input.files[0]);
            }
        }

        // ì´ë¯¸ì§€ë¥¼ Base64ë¡œ ë³€í™˜
        async function imageToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // ì„œë²„ ìƒíƒœ í™•ì¸
        async function checkHealth() {
            const client = getClient();
            const result = await client.healthCheck();
            
            const resultDiv = document.getElementById('healthResult');
            if (result.status === 'healthy') {
                resultDiv.innerHTML = `<div class="result success">
                    <strong>âœ… ì„œë²„ ì •ìƒ ì‘ë™ ì¤‘</strong><br>
                    ì„œë¹„ìŠ¤: ${result.service}<br>
                    ë²„ì „: ${result.version}<br>
                    ë°ì´í„°ë² ì´ìŠ¤: ${result.database}
                </div>`;
            } else {
                resultDiv.innerHTML = `<div class="result error">
                    <strong>âŒ ì„œë²„ ì—°ê²° ì‹¤íŒ¨</strong><br>
                    ${result.error || 'ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'}
                </div>`;
            }
        }

        // í’ˆì§ˆ ê²€ì‚¬
        async function checkQuality() {
            const fileInput = document.getElementById('registerImage');
            if (!fileInput.files[0]) {
                alert('ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            const imageData = await imageToBase64(fileInput.files[0]);
            const client = getClient();
            const result = await client.detectForRegistration(imageData);

            const resultDiv = document.getElementById('registerResult');
            resultDiv.style.display = 'block';

            if (result.success && result.recommendations.suitable_for_registration) {
                resultDiv.className = 'result success';
                resultDiv.innerHTML = `
                    <strong>âœ… í’ˆì§ˆ ê²€ì‚¬ í†µê³¼</strong><br>
                    í’ˆì§ˆ ì ìˆ˜: ${(result.quality_score * 100).toFixed(0)}%<br>
                    ìƒì²´ ì ìˆ˜: ${(result.liveness_score * 100).toFixed(0)}%<br>
                    ì–¼êµ´ í¬ê¸°: ${(result.face_size_ratio * 100).toFixed(0)}%<br>
                    ì•ˆê²½ ê°ì§€: ${result.glasses_detected ? 'ì˜ˆ' : 'ì•„ë‹ˆì˜¤'}
                `;
            } else {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `
                    <strong>âŒ í’ˆì§ˆ ê²€ì‚¬ ì‹¤íŒ¨</strong><br>
                    ${result.recommendations?.messages?.join('<br>') || result.error}
                `;
            }
        }

        // ì–¼êµ´ ë“±ë¡
        async function registerFace() {
            const memberId = document.getElementById('memberId').value;
            const fileInput = document.getElementById('registerImage');
            const securityLevel = parseInt(document.getElementById('securityLevel').value);
            const notes = document.getElementById('notes').value;

            if (!memberId) {
                alert('íšŒì› IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (!fileInput.files[0]) {
                alert('ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            const imageData = await imageToBase64(fileInput.files[0]);
            const client = getClient();
            const result = await client.registerFace(memberId, imageData, securityLevel, notes);

            const resultDiv = document.getElementById('registerResult');
            resultDiv.style.display = 'block';

            if (result.success) {
                resultDiv.className = 'result success';
                resultDiv.innerHTML = `
                    <strong>âœ… ì–¼êµ´ ë“±ë¡ ì„±ê³µ</strong><br>
                    Face ID: ${result.face_id}<br>
                    íšŒì› ID: ${result.member_id}<br>
                    í’ˆì§ˆ ì ìˆ˜: ${(result.quality_score * 100).toFixed(0)}%<br>
                    ìƒì²´ ì ìˆ˜: ${(result.liveness_score * 100).toFixed(0)}%<br>
                    ì•ˆê²½ ê°ì§€: ${result.glasses_detected ? 'ì˜ˆ' : 'ì•„ë‹ˆì˜¤'}
                `;
            } else {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `
                    <strong>âŒ ì–¼êµ´ ë“±ë¡ ì‹¤íŒ¨</strong><br>
                    ${result.error}<br>
                    ${result.details || ''}
                `;
            }
        }

        // ì–¼êµ´ ì¸ì‹
        async function recognizeFace() {
            const fileInput = document.getElementById('recognizeImage');
            const compCd = document.getElementById('compCd').value;
            const bcoffCd = document.getElementById('bcoffCd').value;

            if (!fileInput.files[0]) {
                alert('ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            const imageData = await imageToBase64(fileInput.files[0]);
            const client = getClient();
            const result = await client.recognizeFace(imageData, compCd, bcoffCd);

            const resultDiv = document.getElementById('recognizeResult');
            resultDiv.style.display = 'block';

            if (result.success && result.matched) {
                resultDiv.className = 'result success';
                resultDiv.innerHTML = `
                    <strong>âœ… ì–¼êµ´ ì¸ì‹ ì„±ê³µ</strong><br>
                    íšŒì› ID: ${result.member_id}<br>
                    ìœ ì‚¬ë„: ${(result.similarity * 100).toFixed(1)}%<br>
                    ì‹ ë¢°ë„: ${(result.confidence * 100).toFixed(1)}%<br>
                    ${result.member_info ? `
                        íšŒì›ëª…: ${result.member_info.mem_nm}<br>
                        ì—°ë½ì²˜: ${result.member_info.mem_telno_mask}
                    ` : ''}
                `;
            } else if (result.success && !result.matched) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `
                    <strong>âŒ ë“±ë¡ëœ ì–¼êµ´ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</strong><br>
                    ìµœëŒ€ ìœ ì‚¬ë„: ${(result.similarity * 100).toFixed(1)}%
                `;
            } else {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `
                    <strong>âŒ ì–¼êµ´ ì¸ì‹ ì‹¤íŒ¨</strong><br>
                    ${result.error}
                `;
            }
        }

        // ì²´í¬ì¸
        async function checkinFace() {
            const fileInput = document.getElementById('checkinImage');
            const compCd = document.getElementById('checkinCompCd').value;
            const bcoffCd = document.getElementById('checkinBcoffCd').value;

            if (!fileInput.files[0]) {
                alert('ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            if (!compCd || !bcoffCd) {
                alert('íšŒì‚¬ ì½”ë“œì™€ ì§€ì  ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            const imageData = await imageToBase64(fileInput.files[0]);
            const client = getClient();
            const result = await client.recognizeForCheckin(imageData, compCd, bcoffCd);

            const resultDiv = document.getElementById('checkinResult');
            resultDiv.style.display = 'block';

            if (result.success && result.checkin_allowed) {
                resultDiv.className = 'result success';
                resultDiv.innerHTML = `
                    <strong>âœ… ì²´í¬ì¸ ì„±ê³µ</strong><br>
                    íšŒì› ID: ${result.member_id}<br>
                    ${result.member_info ? `íšŒì›ëª…: ${result.member_info.mem_nm}<br>` : ''}
                    ìœ ì‚¬ë„: ${(result.similarity * 100).toFixed(1)}%<br>
                    ë³´ì•ˆ ë ˆë²¨: ${result.security_level}<br>
                    <hr>
                    ë³´ì•ˆ ê²€ì‚¬ ê²°ê³¼:<br>
                    ${Object.entries(result.security_checks)
                        .map(([key, value]) => `${key}: ${value ? 'âœ…' : 'âŒ'}`)
                        .join('<br>')}
                `;
            } else {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `
                    <strong>âŒ ì²´í¬ì¸ ì‹¤íŒ¨</strong><br>
                    ${result.error || 'ë³´ì•ˆ ê²€ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'}<br>
                    ${result.security_checks ? `
                        <hr>
                        ë³´ì•ˆ ê²€ì‚¬ ê²°ê³¼:<br>
                        ${Object.entries(result.security_checks)
                            .map(([key, value]) => `${key}: ${value ? 'âœ…' : 'âŒ'}`)
                            .join('<br>')}
                    ` : ''}
                `;
            }
        }

        // ì¹´ë©”ë¼ ê´€ë ¨ í•¨ìˆ˜
        async function startCamera() {
            try {
                const video = document.getElementById('video');
                currentStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    } 
                });
                video.srcObject = currentStream;
            } catch (error) {
                alert('ì¹´ë©”ë¼ ì ‘ê·¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
                console.error(error);
            }
        }

        function stopCamera() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
                document.getElementById('video').srcObject = null;
            }
        }

        function capturePhoto() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const preview = document.getElementById('capturedPreview');

            if (!currentStream) {
                alert('ë¨¼ì € ì¹´ë©”ë¼ë¥¼ ì‹œì‘í•´ì£¼ì„¸ìš”.');
                return;
            }

            // ìº”ë²„ìŠ¤ì— ë¹„ë””ì˜¤ í”„ë ˆì„ ê·¸ë¦¬ê¸°
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);

            // Base64ë¡œ ë³€í™˜
            capturedImageData = canvas.toDataURL('image/jpeg');
            
            // ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
            preview.innerHTML = `<img src="${capturedImageData}" alt="Captured">`;
        }

        function useForRegister() {
            if (!capturedImageData) {
                alert('ë¨¼ì € ì‚¬ì§„ì„ ì´¬ì˜í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // ë“±ë¡ íƒ­ìœ¼ë¡œ ì´ë™
            showTab('register');
            
            // ìº¡ì²˜í•œ ì´ë¯¸ì§€ í‘œì‹œ
            document.getElementById('registerPreview').innerHTML = 
                `<img src="${capturedImageData}" alt="Captured">`;
        }

        function useForRecognize() {
            if (!capturedImageData) {
                alert('ë¨¼ì € ì‚¬ì§„ì„ ì´¬ì˜í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // ì¸ì‹ íƒ­ìœ¼ë¡œ ì´ë™
            showTab('recognize');
            
            // ìº¡ì²˜í•œ ì´ë¯¸ì§€ í‘œì‹œ
            document.getElementById('recognizePreview').innerHTML = 
                `<img src="${capturedImageData}" alt="Captured">`;
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì„œë²„ ìƒíƒœ í™•ì¸
        window.onload = function() {
            checkHealth();
        };
    </script>
</body>
</html>