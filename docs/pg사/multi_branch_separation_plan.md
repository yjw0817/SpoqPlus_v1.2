# SpoqPlus 사업장별 분리 계획서

## 1. 개요

### 1.1 목적
현재 SpoqPlus 시스템은 특정 사업장(잠실점, 역삼점)의 정보가 하드코딩되어 있어, 새로운 사업장 추가 시 코드 수정이 필요합니다. 이를 개선하여 DB 설정만으로 다양한 사업장에서 사용할 수 있도록 시스템을 확장 가능하게 만들고자 합니다.

### 1.2 범위
- PG(Payment Gateway) 결제 정보의 DB화
- 계좌정보의 DB 관리
- 사업장별 설정 관리 체계 구축
- 기존 하드코딩된 정보의 마이그레이션

### 1.3 기대효과
- 새로운 사업장 추가 시 코드 수정 불필요
- 사업장별 독립적인 결제 설정 관리
- 유지보수 용이성 향상
- 시스템 확장성 증대

## 2. 현재 상태 분석

### 2.1 하드코딩된 영역
1. **PG 결제 정보** (Api.php)
   - 잠실점: `wpgymjs200` / `NkpsY1B4NXM5c0dNN2xYTmpYMUx6UT09`
   - 역삼점: `wpgym200ys` / `clNSQTgxa2lLZHdMTG1DOEVaME5QZz09`
   - 개발용: `welcometst` / `QjZXWDZDRmxYUXJPYnMvelEvSjJ5QT09`

2. **계좌정보** (new_event_buy_info.php)
   - 국민은행: 12321-13547-125-25
   - 하나은행: 8514-254-45387-11

### 2.2 기존 구조
- 세션 기반 사업장 구분: `$_SESSION['comp_cd']`, `$_SESSION['bcoff_cd']`
- 모든 테이블에 `COMP_CD`, `BCOFF_CD` 컬럼으로 데이터 분리
- API 키는 이미 DB화되어 있음 (api_keys 테이블)

### 2.3 기존 결제 관련 테이블
- **paymt_mgmt_tbl**: 결제 최종 정보 관리
- **paymt_mobile_tbl**: 모바일 결제 요청 정보
- **paymt_mobile_result_tbl**: PG사 응답 정보
- **van_direct_hist**: VAN 결제 이력
- **sales_mgmt_tbl**: 매출 관리

## 3. 개선 방안

### 3.1 DB 스키마 확장 (최소 수정 방식)
1. **bcoff_mgmt_tbl** - 기존 지점 테이블에 JSON 컬럼 추가
   - pg_settings: PG 설정 정보 (JSON)
   - bank_accounts: 계좌 정보 (JSON)
2. **기존 테이블 구조 유지** - 결제 관련 테이블은 그대로 활용

### 3.2 코드 개선
1. PG 정보 조회 로직 구현
2. 계좌정보 동적 조회 구현
3. 하드코딩 제거 및 DB 조회로 대체

### 3.3 마이그레이션
1. 기존 하드코딩된 정보를 DB로 이관
2. 신규 테이블 생성 및 데이터 입력
3. 기존 코드의 점진적 교체

## 4. 구현 단계

### Phase 1: DB 구조 확장 (2일)
- bcoff_mgmt_tbl에 JSON 컬럼 추가
- 기존 하드코딩 데이터를 JSON으로 마이그레이션
- 테스트 데이터 준비

### Phase 2: 코드 개선 (3일)
- BcoffModel 확장 (getPgSettings, getBankAccounts 메소드 추가)
- Api.php Controller 수정 (하드코딩 제거)
- View 파일 수정 (계좌 정보 동적 처리)

### Phase 3: 테스트 및 배포 (2일)
- 기존 결제 프로세스 정상 동작 확인
- 신규 사업장 추가 테스트
- 운영 환경 배포

## 5. 리스크 관리

### 5.1 잠재 리스크
- 기존 결제 프로세스 중단 가능성
- 데이터 마이그레이션 중 오류
- 사업장별 설정 충돌

### 5.2 대응 방안
- 점진적 마이그레이션 전략
- 롤백 계획 수립
- 충분한 테스트 기간 확보

## 6. 성공 지표
- 코드 수정 없이 신규 사업장 추가 가능
- 기존 사업장 정상 운영 유지
- 관리자 UI를 통한 설정 관리 가능