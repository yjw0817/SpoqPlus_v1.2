# 휘트니스센터 회원등록 및 모바일 인증 시스템 개선 계획

## 프로젝트 개요

### 목적
기존 ID/PW 기반 시스템을 유지하면서 회원등록 프로세스를 간소화하고, 모바일 회원 로그인을 전화번호 기반 SMS 인증으로 변경

### 주요 개선사항
1. 센터 회원등록 간소화 (필수정보만 입력)
2. 체크인 번호 자동 생성 (전화번호 뒷4자리 기반)
3. 모바일 SMS 인증 로그인
4. 기존 시스템과의 완벽한 호환성 유지

## 현재 시스템 분석

### 데이터베이스 구조
- **mem_main_info_tbl**: 회원 마스터 테이블
  - mem_id: 체크인 번호로 활용
  - mem_telno: 전화번호 (SMS 로그인용)
  - mem_telno_enc, mem_telno_mask 등: 암호화 필드
  - comp_cd, bcoff_cd: 센터 구분

- **mem_info_detl_tbl**: 회원 상세 정보
  - 회원 추가 정보 저장

### 현재 회원등록 프로세스
- 필수: ID, 비밀번호, 이름, 전화번호
- 선택: 생년월일, 성별, 주소
- ID 중복체크 필수

### 모바일 로그인 현황
- /app/Views/mobile/login.php 이미 구현됨
- ID/PW + 생체인증 + 키패드 지원
- Native Bridge를 통한 앱 연동

## 구현 계획

### 1단계: 체크인 번호(mem_id) 자동생성 로직 구현

#### 1.1 생성 규칙
- 기본: 전화번호 뒷4자리 (예: 01012345678 → 5678)
- 중복시: 뒷4자리 + 순번 (5678 → 56781 → 56782...)
- **중요**: comp_cd가 다르면 같은 번호 사용 가능

#### 1.2 MemModel.php 수정
```php
/**
 * 체크인 번호 자동 생성
 * comp_cd별로 중복 체크하여 사용 가능한 번호 반환
 */
public function generate_mem_id($phone_number, $comp_cd, $bcoff_cd) {
    $last4 = substr($phone_number, -4);
    $mem_id = $last4;
    $suffix = 0;
    
    while ($this->check_mem_id_duplicate($mem_id, $comp_cd, $bcoff_cd)) {
        $suffix++;
        $mem_id = $last4 . $suffix;
    }
    
    return $mem_id;
}

/**
 * comp_cd별 mem_id 중복 체크
 */
public function check_mem_id_duplicate($mem_id, $comp_cd, $bcoff_cd) {
    $sql = "SELECT COUNT(*) as cnt FROM mem_main_info_tbl 
            WHERE mem_id = :mem_id: 
            AND comp_cd = :comp_cd: 
            AND bcoff_cd = :bcoff_cd:";
    
    $query = $this->db->query($sql, [
        'mem_id' => $mem_id,
        'comp_cd' => $comp_cd,
        'bcoff_cd' => $bcoff_cd
    ]);
    
    $result = $query->getResultArray();
    return $result[0]['cnt'] > 0;
}
```

### 2단계: 회원등록 화면 간소화

#### 2.1 UI 변경사항 (/app/Views/inc/jsinc.php)
- ID 입력란 제거 → 체크인 번호 자동 표시
- 비밀번호 입력란 제거
- 필수 항목: 이름, 전화번호, 이메일
- 체크인 번호 실시간 생성 표시

#### 2.2 JavaScript 추가
```javascript
// 전화번호 입력시 체크인 번호 미리보기
$('#new_mem_telno').on('input', function() {
    if ($(this).val().length >= 11) {
        $.ajax({
            url: '/tmemmain/ajax_generate_mem_id',
            type: 'POST',
            data: { phone_number: $(this).val() },
            success: function(result) {
                var json = $.parseJSON(result);
                if (json.result == 'true') {
                    $('#checkin_number_display').text(json.mem_id);
                }
            }
        });
    }
});
```

#### 2.3 Controller 수정 (Tmemmain.php)
```php
/**
 * 체크인 번호 생성 AJAX
 */
public function ajax_generate_mem_id() {
    $phone = $this->request->getPost('phone_number');
    $comp_cd = $this->SpoQCahce->getCacheVar('comp_cd');
    $bcoff_cd = $this->SpoQCahce->getCacheVar('bcoff_cd');
    
    $model = new MemModel();
    $mem_id = $model->generate_mem_id($phone, $comp_cd, $bcoff_cd);
    
    return json_encode([
        'result' => 'true',
        'mem_id' => $mem_id
    ]);
}

/**
 * 회원 등록 처리 수정
 */
public function ajax_mem_insert_proc() {
    // 기존 코드...
    
    // mem_id 자동 생성
    $mdata['mem_id'] = $model->generate_mem_id(
        put_num($postVar['mem_telno']),
        $this->SpoQCahce->getCacheVar('comp_cd'),
        $this->SpoQCahce->getCacheVar('bcoff_cd')
    );
    
    // 비밀번호 고정값 설정
    $mdata['mem_pwd'] = $this->enc_pass(getenv('DEFAULT_MEMBER_PASSWORD'));
    
    // 나머지 처리...
}
```

### 3단계: SMS 인증 시스템 구현

#### 3.1 SMS 인증 테이블 생성
```sql
CREATE TABLE sms_auth_tbl (
    auth_sno INT AUTO_INCREMENT PRIMARY KEY,
    phone_number VARCHAR(20) NOT NULL,
    auth_code VARCHAR(6) NOT NULL,
    created_at DATETIME NOT NULL,
    expired_at DATETIME NOT NULL,
    is_verified CHAR(1) DEFAULT 'N',
    attempt_count INT DEFAULT 0,
    comp_cd VARCHAR(10),
    bcoff_cd VARCHAR(10),
    INDEX idx_phone_comp (phone_number, comp_cd),
    INDEX idx_created (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

#### 3.2 모바일 로그인 수정 (/app/Views/mobile/login.php)
- 기존 ID 입력란을 전화번호 입력란으로 변경
- SMS 인증번호 발송 버튼 추가
- 인증번호 입력 필드 추가

#### 3.3 SMS 인증 Controller (Api.php)
```php
/**
 * SMS 인증번호 발송
 */
public function ajax_sms_send() {
    $phone = $this->request->getPost('phone_number');
    $comp_cd = $this->request->getPost('comp_cd');
    
    // 회원 존재 확인
    $memModel = new MemModel();
    $member = $memModel->get_member_by_phone($phone, $comp_cd);
    
    if (!$member) {
        return json_encode(['result' => 'false', 'msg' => '등록되지 않은 전화번호입니다.']);
    }
    
    // 인증번호 생성 (6자리)
    $auth_code = sprintf("%06d", mt_rand(0, 999999));
    
    // DB 저장
    $authModel = new SmsAuthModel();
    $authModel->save_auth_code($phone, $auth_code, $comp_cd);
    
    // SMS 발송
    $sms = new Ama_sms();
    $sms->send($phone, "[SpoQ] 인증번호: {$auth_code}");
    
    return json_encode(['result' => 'true']);
}

/**
 * SMS 인증번호 확인
 */
public function ajax_sms_verify() {
    $phone = $this->request->getPost('phone_number');
    $auth_code = $this->request->getPost('auth_code');
    $comp_cd = $this->request->getPost('comp_cd');
    
    $authModel = new SmsAuthModel();
    if ($authModel->verify_auth_code($phone, $auth_code, $comp_cd)) {
        // 로그인 처리
        $memModel = new MemModel();
        $member = $memModel->get_member_by_phone($phone, $comp_cd);
        
        // 세션 설정
        $session = session();
        $session->set('user_id', $member['mem_id']);
        $session->set('user_name', $member['mem_nm']);
        // ... 기타 세션 설정
        
        // 무기한 쿠키 설정
        setcookie('spoq_auth', encrypt($member['mem_sno']), time() + (10 * 365 * 24 * 60 * 60));
        
        return json_encode(['result' => 'true']);
    }
    
    return json_encode(['result' => 'false', 'msg' => '인증번호가 일치하지 않습니다.']);
}
```

### 4단계: 기존 회원 데이터 마이그레이션

#### 4.1 마이그레이션 전략
1. 기존 mem_id가 전화번호 형식이 아닌 경우만 처리
2. comp_cd별로 그룹화하여 처리
3. 백업 테이블 생성 후 진행

#### 4.2 마이그레이션 스크립트
```php
// /app/Controllers/Migration.php
public function migrate_mem_id() {
    // 1. 백업 테이블 생성
    $this->db->query("CREATE TABLE mem_id_migration_backup AS 
                      SELECT mem_sno, mem_id, mem_telno, comp_cd, bcoff_cd 
                      FROM mem_main_info_tbl");
    
    // 2. comp_cd별로 처리
    $sql = "SELECT DISTINCT comp_cd, bcoff_cd FROM mem_main_info_tbl";
    $companies = $this->db->query($sql)->getResultArray();
    
    foreach ($companies as $company) {
        $this->migrate_company_members($company['comp_cd'], $company['bcoff_cd']);
    }
}

private function migrate_company_members($comp_cd, $bcoff_cd) {
    // 해당 센터의 회원 조회
    $sql = "SELECT mem_sno, mem_id, mem_telno 
            FROM mem_main_info_tbl 
            WHERE comp_cd = ? AND bcoff_cd = ?
            AND mem_id NOT REGEXP '^[0-9]+$'"; // 숫자로만 구성되지 않은 ID
    
    $members = $this->db->query($sql, [$comp_cd, $bcoff_cd])->getResultArray();
    
    $memModel = new MemModel();
    
    foreach ($members as $member) {
        if (empty($member['mem_telno'])) continue;
        
        // 새 체크인 번호 생성
        $new_mem_id = $memModel->generate_mem_id(
            $member['mem_telno'], 
            $comp_cd, 
            $bcoff_cd
        );
        
        // 업데이트
        $this->db->query("UPDATE mem_main_info_tbl 
                          SET mem_id = ? 
                          WHERE mem_sno = ?", 
                          [$new_mem_id, $member['mem_sno']]);
    }
}
```

### 5단계: 체크인 시스템 연동

#### 5.1 체크인 프로세스 수정
- 회원이 체크인 번호(mem_id) 입력
- comp_cd + mem_id로 회원 조회
- 이용권 확인 및 체크인 처리

#### 5.2 기존 시스템과의 호환성
- 얼굴인식: 그대로 유지
- 키패드 입력: mem_id 입력 방식으로 변경
- QR코드: mem_id 인코딩

## 보안 및 운영 고려사항

### 보안
1. 고정 비밀번호는 .env 파일로 관리
   ```
   DEFAULT_MEMBER_PASSWORD=SpoQ2025!@#
   ```
2. SMS 인증번호 5분 만료
3. 5회 실패시 30분 잠금
4. comp_cd별 독립적인 회원 관리

### 운영
1. 체크인 번호 분실시: 전화번호로 조회 가능
2. 전화번호 변경시: 새로운 체크인 번호 발급
3. comp_cd가 다른 센터: 동일한 체크인 번호 사용 가능

## 테스트 계획

### 단위 테스트
1. 체크인 번호 생성 로직
2. 중복 처리 테스트
3. SMS 발송/인증 테스트

### 통합 테스트
1. 회원등록 전체 프로세스
2. 모바일 로그인 프로세스
3. 체크인 시스템 연동

### 부하 테스트
1. 동시 가입자 처리
2. SMS 대량 발송

## 배포 계획

### 1차 배포 (테스트 센터)
- 1개 센터 선정하여 시범 운영
- 2주간 모니터링

### 2차 배포 (전체 센터)
- 단계적 확대 적용
- 기존 회원 마이그레이션

## 예상 일정

1. 1단계 (체크인 번호 생성): 3일
2. 2단계 (회원등록 간소화): 3일
3. 3단계 (SMS 인증): 5일
4. 4단계 (데이터 마이그레이션): 2일
5. 5단계 (체크인 연동): 2일
6. 테스트 및 안정화: 5일

**총 예상 기간: 20일**

## 참고사항

- 기존 데이터베이스 구조 변경 없음
- 모든 기능은 기존 시스템과 호환
- 센터별 독립적 운영 가능