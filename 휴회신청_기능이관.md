# 휴회신청 기능 이관 프로젝트

## 프로젝트 개요

### 목적
모바일 회원 포털(`mobile_p/new_domcy2.php`)에서 구현된 휴회신청 기능을 교사 포털(`tchr/ttotalmain/info_mem2.php`)로 이관하여, 교사들이 회원의 휴회를 직접 신청할 수 있도록 하는 것

### 배경
- 기존: 휴회신청은 모바일 앱에서만 가능
- 요구사항: 교사가 PC에서 회원 정보를 조회하면서 직접 휴회신청을 처리할 수 있도록 개선

### 작업 범위
1. UI/UX 이관 (모달 창, 레이아웃)
2. JavaScript 로직 이관 (날짜 처리, 유효성 검증)
3. 데이터 연동 (컨트롤러 → 뷰)
4. 반응형 디자인 적용

## 완료된 작업 내역

### 1. 데이터 구조 분석 및 매핑 ✅
- **poss_domcy 데이터 구조 확인**
  - 휴회 가능한 회원권 정보 (회원권명, 시작일, 종료일, 남은 휴회일, 남은 휴회횟수)
  - 컨트롤러(`Ttotalmain.php`)에서 뷰로 전달되는 데이터 확인
  
- **PHP → JavaScript 데이터 전달 구현**
  ```javascript
  const possDomcyData = <?php echo json_encode($poss_domcy ?? [], JSON_HEX_QUOT | JSON_HEX_TAG | JSON_HEX_AMP | JSON_HEX_APOS); ?>;
  ```

- **필드명 매핑 완료**
  - `sell_event_nm` → 회원권명
  - `s_date` → 회원권 시작일
  - `e_date` → 회원권 종료일
  - `day` → 남은 휴회일수
  - `cnt` → 남은 휴회횟수

### 2. UI 구현 ✅
- **Bootstrap 모달 구조 구현**
  - 모달 ID: `modal_pop_domcy`
  - 3단계 구조: 헤더(제목) / 바디(컨텐츠) / 푸터(버튼)

- **날짜 입력 필드 가로 배치**
  - 휴회 시작일과 종료일을 한 줄에 배치
  - 중간에 "~" 구분자 추가
  - Bootstrap Grid System 활용

- **반응형 레이아웃 적용**
  - 모바일에서 줄바꿈 방지 (`white-space: nowrap`)
  - 입력 필드 크기 고정 (`width: 110px`)
  - 날짜 컨테이너에 `display: flex` 적용

- **CSS 스타일 추가**
  ```css
  .date-inputs-container {
      display: flex;
      align-items: center;
      white-space: nowrap;
  }
  .dormancy-start-date, .dormancy-end-date {
      width: 110px !important;
      flex-shrink: 0;
  }
  ```

### 3. JavaScript 기능 구현 ✅

#### 3.1 휴회 항목 동적 생성
- `autoAssignDomcy()` 함수로 휴회 가능한 회원권 목록 동적 생성
- 각 항목에 체크박스, 회원권명, 날짜 필드, 사용일수, 남은 정보 표시

#### 3.2 날짜 자동 할당
- 휴회 시작일과 휴회일수 입력 시 자동으로 각 회원권에 날짜 할당
- 회원권 유효기간 내에서만 할당 가능하도록 제한

#### 3.3 Bootstrap Datepicker 연동
- 모든 날짜 필드에 datepicker 적용
- 한국어 설정 및 날짜 형식 통일 (`yyyy-mm-dd`)
- 회원권 기간 내에서만 선택 가능하도록 제한

#### 3.4 날짜 필드 간 동기화
- **시작일 변경 시**: 종료일 자동 계산 (시작일 + 사용일수 - 1)
- **종료일 변경 시**: 사용일수 자동 계산
- **사용일수 변경 시**: 종료일 자동 계산
- **연쇄 효과**: 한 회원권의 날짜 변경이 다른 회원권에 영향

### 4. 유효성 검증 구현 ✅

#### 4.1 최대 휴회일수 제한
- 각 회원권의 남은 휴회일수(`domcy.day`)를 초과할 수 없도록 제한
- 초과 시 경고 메시지 표시 및 자동 조정

#### 4.2 회원권 기간 내 날짜 제한
- 회원권 시작일 이전 날짜 선택 불가
- 회원권 종료일 이후 날짜 선택 불가
- Datepicker의 `startDate`, `endDate` 옵션으로 제한

#### 4.3 날짜 변경 시 연동 검증
- 시작일 변경 시 종료일이 회원권 종료일을 초과하면 자동 조정
- 종료일 변경 시 계산된 일수가 최대값을 초과하면 자동 조정

### 5. 버그 수정 내역 ✅

#### 5.1 JavaScript 구문 오류 해결
- **문제**: "missing ) after argument list" 에러
- **원인**: `domcy_acppt` 함수의 닫는 중괄호 누락
- **해결**: 3161번 줄의 불필요한 중괄호 제거

#### 5.2 AJAX 404 에러 대응
- **문제**: `/ttotalmain/ajax_get_domcy_list` 엔드포인트 없음
- **해결**: 에러 발생 시 `possDomcyData`를 fallback으로 사용

#### 5.3 데이터 누락 문제 해결
- **문제**: `possDomcyData`가 JavaScript로 전달되지 않음
- **해결**: PHP에서 JavaScript로 데이터 전달 코드 추가

#### 5.4 휴회일 변경 시 리스트 미반영
- **문제**: 상단 휴회일 입력 시 하단 리스트에 반영 안 됨
- **해결**: `daycnt_calu_date()` 함수에서 `autoAssignDomcy()` 호출 추가

#### 5.5 휴회일수 입력시 0으로 변경되는 문제
- **문제**: 사용자가 휴회일수를 입력하면 자동으로 0으로 변경됨
- **원인**: 이벤트 핸들러 중복 및 `updateTotalDays` 함수의 잘못된 동작
- **해결**: 
  - HTML `onkeyup` 속성 제거
  - `$(document).on('input', ...)` 이벤트로 통일
  - `updateTotalDays`가 상단 입력을 덮어쓰지 않도록 수정

#### 5.6 domcy.day가 undefined/0인 경우 처리
- **문제**: "최대 00일 까지만 사용 가능합니다" 메시지 표시
- **원인**: `domcyInfo.day`가 undefined 또는 null인 경우
- **해결**:
  - `parseInt()`를 사용한 안전한 타입 변환
  - 최대 휴회일이 0인 회원권은 표시하지 않음
  - dataset에 필요한 모든 값 저장 (maxDays, maxCnt, memberStart, memberEnd)

#### 5.7 JavaScript 스코프 및 클로저 문제 해결
- **문제**: 하단 리스트 개별 항목에서 최대일 입력시 날짜가 지워짐
- **원인**: 이벤트 핸들러에서 외부 스코프 변수 접근 실패
- **해결**:
  - DOM 탐색을 통한 요소 접근 방식으로 변경
  - dataset을 통한 필요 데이터 저장
  - `updateDatepickerRanges` 함수를 DOM 기반으로 리팩토링
  - 클로저 스코프 문제 완전 해결

## 주요 기능 상세 설명

### 1. 휴회신청 모달
- **열기**: "휴회신청" 버튼 클릭 → `domcy_acppt()` 함수 실행
- **데이터 로드**: AJAX 실패 시 로컬 데이터 사용
- **UI 구성**: 상단 입력 영역 + 하단 회원권 목록

### 2. 날짜 선택 기능
- **휴회 시작일**: 오늘 날짜부터 선택 가능
- **휴회 종료일**: 시작일 + 휴회일수로 자동 계산
- **휴회일수**: 1일 단위로 입력, 최대값 제한

### 3. 회원권별 휴회 항목
- **체크박스**: 휴회 적용 여부 선택
- **날짜 필드**: 개별 수정 가능, datepicker 지원
- **사용일수**: 해당 회원권에서 사용할 휴회일수
- **정보 표시**: 남은 휴회일/횟수 실시간 표시

### 4. 자동 할당 알고리즘
```javascript
1. 휴회 시작일부터 순차적으로 날짜 진행
2. 각 날짜에서 유효한 회원권 확인
3. 최대 휴회일수 내에서 날짜 할당
4. 모든 휴회일이 할당될 때까지 반복
```

## 기술 스택

### Frontend
- **Framework**: Bootstrap 4
- **JavaScript**: jQuery 3.x
- **Datepicker**: Bootstrap Datepicker
- **CSS**: Custom styles + Bootstrap utilities

### Backend
- **Framework**: CodeIgniter 4
- **Language**: PHP 7.4+
- **Database**: MySQL/MariaDB

### 통신
- **Protocol**: AJAX (jQuery.ajax)
- **Format**: JSON
- **Method**: POST

## 테스트 체크리스트

### 기능 테스트 ✅
- [x] 휴회신청 모달 열기/닫기
- [x] 휴회 항목 리스트 표시
- [x] 날짜 선택 (datepicker)
- [x] 날짜 자동 계산
- [x] 날짜 필드 간 동기화
- [x] 최대값 검증
- [x] 체크박스 선택/해제

### UI/UX 테스트 ✅
- [x] 모바일 반응형 (줄바꿈 방지)
- [x] 입력 필드 크기 고정
- [x] 날짜 형식 일관성
- [x] 경고 메시지 표시

### 데이터 테스트 ✅
- [x] PHP → JavaScript 데이터 전달
- [x] AJAX 에러 처리
- [x] 빈 데이터 처리
- [x] 최대값 초과 처리

## 현재 진행 상황 및 차이점 분석

### new_domcy2.php vs info_mem2.php 주요 차이점

#### 1. 초기 상태
- **new_domcy2.php**: 모달 열기 시 날짜 필드 비어있음, 이용권 리스트 비어있음
- **info_mem2.php (현재)**: 날짜 필드에 오늘 날짜 자동 입력, 모든 이용권 표시

#### 2. 이용권 표시 방식
- **new_domcy2.php**: 날짜 선택 후 휴회일수 입력 → 해당 날짜 범위에 유효한 이용권만 표시
- **info_mem2.php (현재)**: 모든 휴회 가능한 이용권을 즉시 표시

#### 3. 날짜 할당 로직
- **new_domcy2.php**: 병렬 할당 (같은 날짜에 여러 이용권 사용 가능)
- **info_mem2.php (현재)**: 순차 할당 (첫 번째 이용권 종료 후 두 번째 시작)

### 완료된 작업 사항

#### 1. autoAssignDomcy 함수 전면 수정 ✅
- 날짜 범위 필터링 로직 구현 완료
- 병렬 할당 방식으로 변경 완료
- 선택된 날짜 범위 내 유효한 이용권만 표시
- 같은 날짜에 여러 이용권 사용 가능

#### 2. UI/UX 개선 ✅
- 날짜 미선택 시 이용권 리스트 비움
- 이용권 리스트 동적 업데이트
- 최대 사용 가능 일수 표시
- 휴회일을 1일 이상 입력할 때만 하단 이용권 리스트 표시

#### 3. 유효성 검증 강화 ✅
- 날짜 선택 전 휴회일수 입력 시 알림
- 이용권별 최대 휴회일 검증
- datepicker 범위 동적 업데이트
- 휴회 시작일은 오늘부터 선택 가능하도록 수정

## 완료된 모든 이슈

### 모든 주요 버그 해결 완료 ✅
- ✅ 휴회일수 입력시 0으로 변경되는 문제
- ✅ 하단 리스트 개별 수정시 종료일 사라지는 문제  
- ✅ 최대일수 입력시 날짜가 지워지는 문제
- ✅ JavaScript 스코프 및 클로저 문제
- ✅ "최대 00일 까지만 사용 가능합니다" 메시지 문제

### 기능 구현 완료 ✅
- ✅ 모달 UI 구현 및 반응형 디자인
- ✅ 날짜 필드 가로 배치 및 datepicker 연동
- ✅ 휴회 가능한 회원권 동적 생성
- ✅ 날짜 자동 계산 및 동기화
- ✅ 유효성 검증 (최대일수, 회원권 기간)
- ✅ new_domcy2.php와 동일한 동작 방식 구현

## 서버 API 구현 완료

### 1. ajax_get_domcy_list ✅
- 휴회 가능한 회원권 목록을 조회하는 API 구현 완료
- Domcy_lib를 통해 poss_domcy 데이터 반환
- JSON 형식으로 응답

### 2. ajax_domcy_acppt_multi_proc ✅
- 여러 회원권을 동시에 휴회 신청할 수 있는 새로운 API 구현
- 기존 단일 처리 방식과 병행 사용 가능
- 성공/실패 개수 및 상세 에러 메시지 반환
- 날짜 계산 로직 포함

### 3. submitDomcyApplication 함수 완성 ✅
- 선택된 회원권들의 휴회 정보 수집
- 확인 다이얼로그로 사용자 의사 재확인
- 로딩 표시 및 에러 처리
- 성공시 자동 새로고침
- API 형식에 맞춰 items 배열로 전송 (사용자 요청에 따라 변경)
- 한 번의 요청으로 모든 휴회 신청 처리
- buy_event_sno가 dataset을 통해 전달되도록 수정

## 최종 구현 완료 사항

### 휴회 신청 프로세스 ✅
1. **체크박스 클래스명 통일**: `item-check` → `dormancy-checkbox`로 변경하여 일관성 확보
2. **휴회일수 선택자 수정**: `.domcy-days` → `.use-days`로 변경하여 올바른 요소 선택
3. **새로운 메서드 구현**: 인증 문제 해결을 위해 `ajax_domcy_acppt_items_proc` 메서드 생성
   - API 컨트롤러의 로직을 복사하여 교사 포털용으로 수정
   - 세션 기반 인증으로 로그인 문제 해결
   - 다중 처리와 중복 처리 지원

### 사용자가 보고한 모든 이슈 해결 ✅
1. ✅ "휴회 신청할 항목을 선택해주세요" 메시지 - 체크박스 클래스명 수정으로 해결
2. ✅ "총 0일의 휴회를 진행하시겠습니까" 메시지 - 휴회일수 선택자 수정으로 해결
3. ✅ 인증 오류 - 교사 포털 전용 메서드 생성으로 해결
4. ✅ 응답 처리 오류 - JSON 파싱 및 응답 형식 통일로 해결

## 향후 개선 사항

### 1. 사용자 경험 개선
- 로딩 인디케이터 추가
- 애니메이션 효과
- 툴팁 및 도움말
- 에러 핸들링 강화

### 2. 검증 강화
- 중복 휴회 기간 체크
- 휴회 횟수 제한 검증
- 비즈니스 규칙 추가

### 3. 코드 품질 개선
- 전체적인 리팩토링으로 유지보수성 향상
- 함수 분리 및 모듈화
- 주석 및 문서화 강화

## 참고 자료

### 관련 파일
1. **원본**: `/app/Views/mobile_p/new_domcy2.php`
2. **대상**: `/app/Views/tchr/ttotalmain/info_mem2.php`
3. **컨트롤러**: `/app/Controllers/Ttotalmain.php`

### 주요 함수
- `domcy_acppt()`: 휴회신청 모달 열기
- `autoAssignDomcy()`: 휴회 날짜 자동 할당
- `daycnt_calu_date()`: 휴회일수 계산
- `redistributeDates()`: 날짜 재배치
- `updateTotalDays()`: 총 휴회일 업데이트

### 데이터 구조
```javascript
possDomcyData = {
  list: [
    {
      buy_event_sno: "SNO",
      sell_event_nm: "회원권명",
      s_date: "2024-01-01",
      e_date: "2024-12-31",
      day: 30,  // 남은 휴회일
      cnt: 3    // 남은 휴회횟수
    }
  ]
}
```

## 완료 상태

**전체 진행률: 100%** 🎉

### 최종 테스트 완료 항목 ✅
- ✅ 휴회 항목 선택 및 체크박스 동작
- ✅ 휴회일수 계산 및 표시
- ✅ 다중 휴회 신청 서버 전송
- ✅ 기존 API와의 호환성
- ✅ 성공/실패 메시지 표시 및 화면 갱신

- ✅ 데이터 구조 분석 (100%)
- ✅ UI 구현 (100%)
- ✅ JavaScript 기능 (100%)
- ✅ 유효성 검증 (100%)
- ✅ 버그 수정 (100%)
- ✅ new_domcy2.php 동작 방식 구현 (100%)
  - ✅ 모달 초기 상태 변경 (날짜 필드 비움)
  - ✅ 날짜 선택 후 이용권 필터링
  - ✅ 병렬 할당 로직 구현
  - ✅ 동적 이용권 리스트 생성
  - ✅ 휴회일 1일 이상 입력시에만 리스트 표시
  - ✅ 휴회 시작일 오늘부터 선택 가능
  - ✅ 하단 리스트 개별 항목 최대일 처리
- ✅ domcy.day가 undefined 또는 0인 경우 안전한 처리 (100%)
  - ✅ parseInt()를 사용한 안전한 정수 변환
  - ✅ 최대 휴회일이 0인 회원권은 표시하지 않음
  - ✅ "최대 00일 까지만 사용 가능합니다" 메시지 문제 해결
- ✅ JavaScript 스코프 문제 완전 해결 (100%)
  - ✅ updateDatepickerRanges 함수를 DOM 기반으로 리팩토링
  - ✅ 모든 클로저 스코프 이슈 해결
- ✅ 서버 API 연동 (100%)
  - ✅ ajax_get_domcy_list 메서드 구현
  - ✅ ajax_domcy_acppt_multi_proc 메서드 구현
- ✅ 실제 휴회 신청 처리 (100%)
  - ✅ submitDomcyApplication 함수 완성
  - ✅ 체크박스 및 휴회일수 선택자 수정 완료
  - ✅ 기존 ajax_domcy_acppt_proc API 활용
  - ✅ 순차적 다중 처리 구현
  - ✅ 로딩 표시 및 에러 처리
  - ✅ 성공시 자동 새로고침

## 2024-12-19 추가 개선 사항 완료 ✅

### Toast 알림 시스템 구현
휴회 신청 결과를 더 보기 좋게 표시하기 위해 Toast 팝업 시스템을 구현했습니다.

#### 1. **성공 메시지 개선**
- 기존: `alert()` 다이얼로그
- 개선: `alertToast('success', message)` - 녹색 성공 토스트
- 1.5초 지연 후 페이지 새로고침으로 사용자가 메시지를 확인할 수 있도록 개선

#### 2. **오류 메시지 개선**
- 기존: `alert()` 다이얼로그
- 개선: `alertToast('error', message)` - 빨간색 오류 토스트
- 로그인 만료, JSON 파싱 오류, AJAX 오류 등 모든 오류 상황에 적용

#### 3. **확인 다이얼로그 개선**
- 기존: `confirm()` 브라우저 기본 다이얼로그
- 개선: SweetAlert2 확인 다이얼로그
  - 제목: "휴회 신청 확인"
  - 내용: 총 휴회일수와 선택된 회원권 개수 표시
  - 버튼: "신청하기" (파란색), "취소" (빨간색)
  - 브랜딩: "Argos SpoQ" 푸터 추가

#### 4. **로딩 표시 추가**
- 처리 중 상태를 알려주는 정보 토스트 추가
- 메시지: "휴회 신청을 처리중입니다..."

#### Toast 알림 특징
- **위치**: 화면 상단 중앙
- **표시 시간**: 3초 (자동 사라짐)
- **너비**: 500px
- **상호작용**: 마우스 오버 시 일시정지
- **진행 표시**: 남은 시간 프로그레스 바
- **아이콘**: 성공(✓), 오류(✗), 정보(ℹ)
- **브랜딩**: "Argos SpoQ" 푸터

**최종 상태**: 
- 휴회신청 기능 이관 완료 ✅
- Toast 알림 시스템 구현 완료 ✅
- 모든 기능이 정상 작동함
- 모바일 버전과 동일한 기능을 교사 포털에서 사용 가능
- 사용자 친화적인 알림 시스템으로 UX 개선

## 2024-12-19 UI/UX 개선 사항 완료 ✅

### 모달 디자인 개선
휴회 신청 모달의 디자인을 사용자 친화적으로 개선했습니다.

#### 1. **모달 크기 최적화**
- 기존: `modal-lg` (넓은 모달)
- 개선: `max-width: 600px` (적절한 크기로 축소)
- 모바일 반응형 유지

#### 2. **헤더 디자인 개선**
- 보라색 그라데이션 배경 적용
- 흰색 텍스트로 가독성 향상
- 아이콘 추가로 시각적 구분

#### 3. **섹션별 구조화**
- 날짜 설정 섹션과 회원권 목록 섹션 분리
- 배경색과 그림자로 시각적 계층 구조 표현
- 각 섹션에 아이콘과 제목 추가

#### 4. **회원권 항목 개선**
- 카드 형태의 깔끔한 디자인
- 호버 효과로 인터랙션 강화
- 날짜 필드 가로 배치로 공간 효율성 증대
- 남은 정보를 시각적으로 명확하게 표시

#### 5. **동적 기능 유지**
- 모든 날짜 연동 기능 정상 작동
- 자동 할당 알고리즘 유지
- datepicker 기능 완벽 호환
- 체크박스 선택/해제 기능 유지

**구현 완료**: 
- 모달 디자인 현대적으로 개선 ✅
- 사용자 경험 향상 ✅
- 모든 기능 정상 작동 확인 ✅